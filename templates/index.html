<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagnóstico do Sistema</title>
</head>
<body>
    <h2>Executar Diagnóstico</h2>
    <button onclick="coletarInformacoes()">Iniciar Coleta</button>
    <pre id="resultado"></pre>

    <script>
        async function medirVelocidade() {
            const fileSizeInBytes = 1048576 * 10; // 10MB
            const testFile = "https://speed.hetzner.de/10MB.bin"; // Arquivo de teste
            try {
                const startTime = performance.now();
                await fetch(testFile, { cache: "no-cache", mode: "no-cors" });
                const endTime = performance.now();
                
                const durationInSeconds = (endTime - startTime) / 1000;
                const speedMbps = (fileSizeInBytes / 1024 / 1024 * 8) / durationInSeconds;
                
                return speedMbps.toFixed(2);
            } catch (error) {
                return "Erro ao medir velocidade";
            }
        }

        async function coletarInformacoes() {
            const info = {
                "Navegador": navigator.userAgent,
                "Plataforma": navigator.platform,
                "Linguagem": navigator.language,
                "Resolução de Tela": `${window.screen.width}x${window.screen.height}`
            };

            // Coletar IP Público
            try {
                const ipResponse = await fetch("https://api64.ipify.org?format=json");
                const ipData = await ipResponse.json();
                info["IP Público"] = ipData.ip;
            } catch (error) {
                info["IP Público"] = "Erro ao obter IP";
            }

            // Coletar informações do hardware
            if (navigator.deviceMemory) {
                info["Memória RAM (GB)"] = navigator.deviceMemory;
            }

            if (navigator.hardwareConcurrency) {
                info["Núcleos da CPU"] = navigator.hardwareConcurrency;
            }

            // Medir velocidade de download do cliente
            info["Velocidade de Download (Mbps)"] = await medirVelocidade();

            // Enviar os dados para o servidor Flask
            fetch("/coletar", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(info)
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById("resultado").innerText = JSON.stringify(data, null, 4);
            })
            .catch(error => {
                document.getElementById("resultado").innerText = "Erro ao enviar os dados: " + error;
            });
        }
    </script>
</body>
</html>
